import * as pg from 'pg';
import * as dotenv from 'dotenv';

dotenv.config();

const pool = new pg.Pool({ connectionString: process.env.SUPABASE_DB_URL });

export interface AdvancedFilters {
  category?: string[];
  evidence_level?: string[];
  severity?: string[];
  year_range?: { min?: number; max?: number };
}

export interface RetrievedAdvanced {
  id: string;
  text: string;
  source: string;
  year: number;
  category: string;
  evidence_level: string;
  severity: string;
  score: number;
}

/**
 * B√∫squeda avanzada con filtros por metadatos
 */
export async function retrieveContextAdvanced(
  userQuery: string,
  language: 'Espa√±ol' | 'English',
  filters?: AdvancedFilters,
  topK: number = 10,
): Promise<RetrievedAdvanced[]> {
  try {
    // Construir la consulta SQL din√°micamente
    let sql = `
      SELECT 
        id, text, source, year, 
        COALESCE(category, 'general') as category,
        COALESCE(evidence_level, 'D') as evidence_level,
        COALESCE(severity, 'low') as severity,
        1.0 as score
      FROM docs
      WHERE language = $1
    `;

    const params: any[] = [language];
    let paramIndex = 2;

    // Agregar filtros de categor√≠a
    if (filters?.category && filters.category.length > 0) {
      sql += ` AND category = ANY($${paramIndex})`;
      params.push(filters.category);
      paramIndex++;
    }

    // Agregar filtros de nivel de evidencia
    if (filters?.evidence_level && filters.evidence_level.length > 0) {
      sql += ` AND evidence_level = ANY($${paramIndex})`;
      params.push(filters.evidence_level);
      paramIndex++;
    }

    // Agregar filtros de severidad
    if (filters?.severity && filters.severity.length > 0) {
      sql += ` AND severity = ANY($${paramIndex})`;
      params.push(filters.severity);
      paramIndex++;
    }

    // Agregar filtros de a√±o
    if (filters?.year_range) {
      if (filters.year_range.min) {
        sql += ` AND year >= $${paramIndex}`;
        params.push(filters.year_range.min);
        paramIndex++;
      }
      if (filters.year_range.max) {
        sql += ` AND year <= $${paramIndex}`;
        params.push(filters.year_range.max);
        paramIndex++;
      }
    }

    // Ordenar por relevancia (priorizar evidencia A, luego B, etc.)
    sql += `
      ORDER BY 
        CASE evidence_level
          WHEN 'A' THEN 1
          WHEN 'B' THEN 2
          WHEN 'C' THEN 3
          WHEN 'D' THEN 4
          ELSE 5
        END,
        year DESC
      LIMIT $${paramIndex}
    `;

    params.push(topK);

    console.log('üîç Advanced RAG query:', sql);
    console.log('üîç Parameters:', params);

    const { rows } = await pool.query(sql, params);

    console.log(
      `‚úÖ Advanced RAG found ${rows.length} results for "${userQuery}" in ${language}`,
    );

    return rows as RetrievedAdvanced[];
  } catch (error) {
    console.error('Error in advanced RAG:', error);
    // Fallback: retornar array vac√≠o
    return [];
  }
}

/**
 * B√∫squeda inteligente que detecta idioma y busca en ambos idiomas
 */
export async function retrieveContextSmart(
  userQuery: string, // Query original del usuario
  topK: number = 10,
): Promise<RetrievedAdvanced[]> {
  console.log('üöÄ retrieveContextSmart iniciado');
  console.log('üöÄ Query original:', userQuery);
  console.log('üöÄ TopK:', topK);

  // Detectar idioma de la consulta
  const detectedLanguage = detectLanguage(userQuery);
  console.log('üåç Idioma detectado:', detectedLanguage);

  // Detectar categor√≠a m√©dica
  const detectedCategory = detectMedicalCategory(userQuery);
  console.log('üöÄ Categor√≠a detectada:', detectedCategory);

  // Crear filtros si detectamos categor√≠a
  const filters: AdvancedFilters | undefined = detectedCategory
    ? {
        category: [detectedCategory],
        evidence_level: ['A', 'B'], // Priorizar evidencia alta
        severity: ['low', 'medium'], // Evitar casos de emergencia
      }
    : undefined;

  console.log('üöÄ Filtros aplicados:', filters);

  // Buscar primero en el idioma original del usuario
  let results = await retrieveContextAdvanced(
    userQuery,
    detectedLanguage,
    filters,
    Math.ceil(topK * 0.7), // 70% de resultados del idioma original
  );

  console.log(
    `‚úÖ Encontrados ${results.length} resultados en ${detectedLanguage}`,
  );

  // Si no hay suficientes resultados, buscar en el otro idioma
  if (results.length < topK) {
    const otherLanguage =
      detectedLanguage === 'Espa√±ol' ? 'English' : 'Espa√±ol';
    const remainingCount = topK - results.length;

    console.log(
      `üîÑ Buscando ${remainingCount} resultados adicionales en ${otherLanguage}`,
    );

    const otherResults = await retrieveContextAdvanced(
      userQuery,
      otherLanguage,
      filters,
      remainingCount,
    );

    console.log(
      `‚úÖ Encontrados ${otherResults.length} resultados adicionales en ${otherLanguage}`,
    );

    // Combinar resultados, priorizando el idioma original
    results = [...results, ...otherResults];
  }

  console.log(`üéØ Total de resultados: ${results.length}`);
  return results;
}

/**
 * Detectar idioma de la consulta del usuario
 */
function detectLanguage(text: string): 'Espa√±ol' | 'English' {
  const queryLower = text.toLowerCase();

  // Patrones t√≠picos del espa√±ol
  const spanishPattern = /[√°√©√≠√≥√∫√±√º]/i;
  const spanishWords = [
    'me',
    'te',
    'se',
    'le',
    'nos',
    'os',
    'les',
    'que',
    'de',
    'el',
    'la',
    'los',
    'las',
    'tengo',
    'tiene',
    'dolor',
    'duele',
    'problema',
    's√≠ntoma',
    'enfermedad',
    'tratamiento',
  ];

  // Si tiene caracteres especiales del espa√±ol o palabras comunes
  if (
    spanishPattern.test(text) ||
    spanishWords.some((word) => queryLower.includes(word))
  ) {
    return 'Espa√±ol';
  }

  return 'English';
}

/**
 * Detectar categor√≠a m√©dica de la consulta
 */
function detectMedicalCategory(userQuery: string): string | null {
  const queryLower = userQuery.toLowerCase();

  console.log('üîç DEBUG: detectMedicalCategory iniciado');
  console.log('üîç DEBUG: Query original:', userQuery);
  console.log('üîç DEBUG: Query en min√∫sculas:', queryLower);

  const medicalCategories = [
    // Cardiolog√≠a y circulaci√≥n
    {
      keywords: [
        'heart',
        'cardiac',
        'cardiovascular',
        'blood pressure',
        'hypertension',
        'coraz√≥n',
        'cardiaco',
        'cardiovascular',
        'presi√≥n',
        'hipertensi√≥n',
        'palpitaciones',
        'palpitations',
        'dolor de pecho',
        'chest pain',
        'mareo',
        'dizziness',
        'fatiga',
        'fatigue',
        'edema',
        'swelling',
      ],
      category: 'cardiology',
    },
    // Neurolog√≠a y cerebro
    {
      keywords: [
        'brain',
        'neurological',
        'nervous',
        'headache',
        'migraine',
        'cerebro',
        'neurol√≥gico',
        'nervioso',
        'dolor de cabeza',
        'migra√±a',
        'jaqueca',
        'cabeza',
        'duele cabeza',
        'dolor cabeza',
        'memory',
        'memoria',
        'concentration',
        'concentraci√≥n',
        'tremor',
        'temblor',
        'numbness',
        'entumecimiento',
        'seizure',
        'convulsi√≥n',
      ],
      category: 'neurology',
    },
    // Pediatr√≠a y ni√±os
    {
      keywords: [
        'child',
        'pediatric',
        'infant',
        'baby',
        'ni√±o',
        'pedi√°trico',
        'beb√©',
        'infante',
        'fever',
        'fiebre',
        'vaccine',
        'vacuna',
        'growth',
        'crecimiento',
        'development',
        'desarrollo',
      ],
      category: 'pediatrics',
    },
    // Dermatolog√≠a y piel
    {
      keywords: [
        'skin',
        'dermatology',
        'rash',
        'acne',
        'piel',
        'dermatolog√≠a',
        'erupci√≥n',
        'acn√©',
        'itch',
        'picaz√≥n',
        'burn',
        'quemadura',
        'wound',
        'herida',
        'mole',
        'lunar',
        'hair loss',
        'ca√≠da de pelo',
      ],
      category: 'dermatology',
    },
    // Psiquiatr√≠a y salud mental
    {
      keywords: [
        'mental',
        'psychology',
        'anxiety',
        'depression',
        'stress',
        'mental',
        'psicolog√≠a',
        'ansiedad',
        'depresi√≥n',
        'estr√©s',
        'panic',
        'p√°nico',
        'mood',
        'estado de √°nimo',
        'sleep',
        'sue√±o',
        'insomnia',
        'insomnio',
        'appetite',
        'apetito',
        'concentration',
      ],
      category: 'psychiatry',
    },
    // Endocrinolog√≠a y metabolismo
    {
      keywords: [
        'diabetes',
        'insulin',
        'blood sugar',
        'glucose',
        'diabetes',
        'insulina',
        'az√∫car',
        'glucosa',
        'thyroid',
        'tiroides',
        'hormone',
        'hormona',
        'weight',
        'peso',
        'metabolism',
        'metabolismo',
        'cholesterol',
        'colesterol',
        'thyroid',
        'tiroides',
      ],
      category: 'endocrinology',
    },
    // Gastroenterolog√≠a
    {
      keywords: [
        'stomach',
        'est√≥mago',
        'digestion',
        'digesti√≥n',
        'nausea',
        'n√°usea',
        'vomit',
        'v√≥mito',
        'diarrhea',
        'diarrea',
        'constipation',
        'estre√±imiento',
        'bloating',
        'hinchaz√≥n',
        'acid reflux',
        'reflujo',
        'ulcer',
        '√∫lcera',
        'liver',
        'h√≠gado',
        'gallbladder',
        'ves√≠cula',
      ],
      category: 'gastroenterology',
    },
    // Respiratorio
    {
      keywords: [
        'lung',
        'pulm√≥n',
        'breathing',
        'respiraci√≥n',
        'cough',
        'tos',
        'asthma',
        'asma',
        'bronchitis',
        'bronquitis',
        'pneumonia',
        'neumon√≠a',
        'shortness of breath',
        'falta de aire',
        'wheezing',
        'sibilancias',
        'chest congestion',
        'congesti√≥n de pecho',
      ],
      category: 'respiratory',
    },
    // Ortopedia y m√∫sculos
    {
      keywords: [
        'bone',
        'hueso',
        'joint',
        'articulaci√≥n',
        'muscle',
        'm√∫sculo',
        'back pain',
        'dolor de espalda',
        'knee',
        'rodilla',
        'shoulder',
        'hombro',
        'fracture',
        'fractura',
        'sprain',
        'esguince',
        'arthritis',
        'artritis',
        'inflammation',
        'inflamaci√≥n',
      ],
      category: 'orthopedics',
    },
    // Ginecolog√≠a y salud femenina
    {
      keywords: [
        'pregnancy',
        'embarazo',
        'menstruation',
        'menstruaci√≥n',
        'ovary',
        'ovario',
        'breast',
        'seno',
        'mammogram',
        'mamograf√≠a',
        'menopause',
        'menopausia',
        'fertility',
        'fertilidad',
      ],
      category: 'gynecology',
    },
    // Urolog√≠a y salud masculina
    {
      keywords: [
        'prostate',
        'pr√≥stata',
        'urination',
        'micci√≥n',
        'kidney',
        'ri√±√≥n',
        'bladder',
        'vejiga',
        'urinary tract',
        'tracto urinario',
        'erectile dysfunction',
        'disfunci√≥n er√©ctil',
      ],
      category: 'urology',
    },
    // Oftalmolog√≠a y visi√≥n
    {
      keywords: [
        'eye',
        'ojo',
        'vision',
        'visi√≥n',
        'blur',
        'borrosa',
        'dry eyes',
        'ojos secos',
        'redness',
        'enrojecimiento',
        'glasses',
        'lentes',
        'contact lens',
        'lentes de contacto',
        'cataract',
        'catarata',
      ],
      category: 'ophthalmology',
    },
    // Otorrinolaringolog√≠a
    {
      keywords: [
        'ear',
        'o√≠do',
        'nose',
        'nariz',
        'throat',
        'garganta',
        'hearing',
        'audici√≥n',
        'tinnitus',
        'zumbido',
        'sinus',
        'seno nasal',
        'tonsil',
        'am√≠gdala',
        'voice',
        'voz',
      ],
      category: 'ent',
    },
    // Inmunolog√≠a y alergias
    {
      keywords: [
        'allergy',
        'alergia',
        'immune',
        'inmune',
        'infection',
        'infecci√≥n',
        'fever',
        'fiebre',
        'inflammation',
        'inflamaci√≥n',
        'autoimmune',
        'autoinmune',
        'vaccine',
        'vacuna',
        'antibody',
        'anticuerpo',
      ],
      category: 'immunology',
    },
    // Nutrici√≥n y bienestar
    {
      keywords: [
        'nutrition',
        'nutrici√≥n',
        'diet',
        'dieta',
        'vitamin',
        'vitamina',
        'supplement',
        'suplemento',
        'weight loss',
        'p√©rdida de peso',
        'healthy eating',
        'alimentaci√≥n saludable',
        'fiber',
        'fibra',
      ],
      category: 'nutrition',
    },
    // Sue√±o y descanso
    {
      keywords: [
        'sleep',
        'insomnia',
        'dormir',
        'sue√±o',
        'no puedo dormir',
        'problemas para dormir',
        'dificultad para dormir',
        'rest',
        'descanso',
        'tired',
        'cansado',
        'energy',
        'energ√≠a',
        'circadian',
        'circadiano',
      ],
      category: 'sleep',
    },
    // Dolor general
    {
      keywords: [
        'pain',
        'dolor',
        'ache',
        'duele',
        'me duele',
        'chronic pain',
        'dolor cr√≥nico',
        'acute pain',
        'dolor agudo',
        'discomfort',
        'malestar',
        'sore',
        'adolorido',
        'tender',
        'sensible',
      ],
      category: 'pain_management',
    },
  ];

  for (const { keywords, category } of medicalCategories) {
    console.log('üîç DEBUG: Probando categor√≠a:', category);
    console.log('üîç DEBUG: Keywords:', keywords);

    const hasMatch = keywords.some((keyword) => queryLower.includes(keyword));
    console.log('üîç DEBUG: ¬øHay match?', hasMatch);

    if (hasMatch) {
      console.log('üéØ DEBUG: ¬°Categor√≠a encontrada!', category);
      return category;
    }
  }

  console.log('‚ùå DEBUG: No se encontr√≥ ninguna categor√≠a');
  return null;
}
